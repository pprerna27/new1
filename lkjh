import smtplib
from email.message import EmailMessage
import openpyxl
import os

# ==== CONFIGURATION ====
SMTP_SERVER = "smtp.office365.com"   # For Outlook. Use smtp.gmail.com for Gmail
SMTP_PORT = 587
SENDER_EMAIL = "your_email@example.com"
PASSWORD = "your_app_password"   # For Gmail/Outlook, generate an App Password
WORKBOOK_PATH = "recipients.xlsx"   # Workbook containing To/CC in each sheet
ATTACHMENT_PATH = "report.xlsx"     # File to attach
FIXED_SUBJECT = "Status Update for Category"
FIXED_BODY = """Hello Team,

Please find attached the latest report.

Regards,
Your Name
"""
# =======================


def send_mail(to_list, cc_list, subject, body, attachment):
    msg = EmailMessage()
    msg["From"] = SENDER_EMAIL
    msg["To"] = ", ".join(to_list)
    if cc_list:
        msg["Cc"] = ", ".join(cc_list)
    msg["Subject"] = subject
    msg.set_content(body)

    # Attach file
    if attachment and os.path.exists(attachment):
        with open(attachment, "rb") as f:
            file_data = f.read()
            file_name = os.path.basename(attachment)
        msg.add_attachment(file_data, maintype="application", subtype="octet-stream", filename=file_name)

    # Send email
    with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as server:
        server.starttls()
        server.login(SENDER_EMAIL, PASSWORD)
        server.send_message(msg)


def main():
    wb = openpyxl.load_workbook(WORKBOOK_PATH)

    for sheet_name in wb.sheetnames:
        sheet = wb[sheet_name]
        
        # Assuming "To" emails in column A, "CC" emails in column B
        to_list = [cell.value for cell in sheet["A"] if cell.value]
        cc_list = [cell.value for cell in sheet["B"] if cell.value]

        subject = f"{FIXED_SUBJECT} - {sheet_name}"
        print(f"Sending mail for sheet: {sheet_name} | To: {to_list} | CC: {cc_list}")
        
        send_mail(to_list, cc_list, subject, FIXED_BODY, ATTACHMENT_PATH)


if __name__ == "__main__":
    main()